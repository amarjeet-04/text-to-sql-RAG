### BASE TABLE RULE
• Always use BookingData as the base table.
• All queries must start FROM BookingData BD.
• Dimension tables must be LEFT JOINed to BookingData.
• Never start FROM AgentMaster_V1, Master_Country, Master_City, or Supplier tables.

• Only JOIN a dimension table if the user's question explicitly mentions:
  - agent / client / travel agent → then join AgentMaster_V1
  - supplier / vendor            → then join suppliermaster_Report
  - hotel / property             → then join Hotelchain
  - country                      → then join Master_Country
  - city                         → then join Master_City
  If the question only asks for revenue, profit, or bookings with no dimension breakdowns, use BookingData alone.


Example — revenue/profit/bookings only (no dimension mentioned):
FROM BookingData BD

Example — when agent or client is mentioned:
FROM BookingData BD
LEFT JOIN dbo.AgentMaster_V1 A ON BD.AgentId = A.AgentId

Example — when supplier is mentioned:
FROM BookingData BD
LEFT JOIN dbo.suppliermaster_Report SM ON BD.SupplierId = SM.EmployeeId

### GLOBAL FILTERS
• Default KPI filter:
  BD.BookingStatus NOT IN ('Cancelled','Not Confirmed','On Request')
• Exception:
  Total Cancelled Bookings uses BookingStatus = 'Cancelled'

### DATE FILTER RULES
• Never use CAST(date_col AS DATE) in WHERE.
• Always use SARGable ranges:
  BD.CreatedDate >= 'YYYY-MM-DD'
  AND BD.CreatedDate < 'YYYY-MM-DD'
• If the user does NOT mention any time period, do NOT add a date filter.
• Only add a date filter when the user explicitly mentions a year, month, period, or uses words like "this year", "last month", "YTD", "2024", etc.

### FOLLOW-UP QUERY RULES
• A follow-up question is one that uses words like "more", "that", "those", "it", "also",
  or references a specific name/value from a previous answer (e.g. "give me more about Agoda").
• When the question is a follow-up:
  - Copy the EXACT date filter (CreatedDate >= / <) from the previous SQL in HISTORY as-is.
  - Do NOT replace it with the current month, current year, or any default window.
  - Do NOT add any new date filter if the previous SQL had none.
  - Only add or change the date filter if the user explicitly states a new time period.
• When the question is self-contained (has its own year, month, or date range):
  - Ignore HISTORY and build the date filter fresh from the user's request.

### DUPLICATE PREVENTION
• Lookup tables may contain duplicates.
• Use DISTINCT mapping if needed:
  WITH AM AS (
    SELECT DISTINCT AgentId, AgentName
    FROM AgentMaster_V1
  )

### TERMINOLOGY MAP (business word → SQL column)
• "client" / "agent" / "travel agent" / "B2B partner" → AgentMaster_V1.AgentName
• "supplier" / "hotel supplier" / "vendor" → suppliermaster_Report.SupplierName
• "hotel" / "property" → Hotelchain.HotelName
• "country" → Master_Country.Country  (destination country)
• "city" → Master_City.City
• When a question mentions both hotel chain and country:
  - Chain MUST come from Hotelchain (via BD.ProductId = HC.HotelId)
  - Country MUST come from Master_Country.Country via BD.ProductCountryid
  - Do NOT use Hotelchain.Country unless the user explicitly asks for hotel country / property country / hotel location country
• NEVER map "client" to BD.ClientNatinality, BD.Nationality, or any nationality column.

### AGENT DIMENSION RULES
• JOIN AgentMaster ONLY when the question mentions agent / client / travel agent / B2B partner:
  LEFT JOIN dbo.AgentMaster_V1 A ON BD.AgentId = A.AgentId
• AgentName = A.AgentName
• AgentCode = A.AgentCode
• AgentType:
  - Prefer AgentTypeMapping if available:
    LEFT JOIN dbo.AgentTypeMapping ATM ON ATM.AgentId = BD.AgentId
    AgentType = ATM.agenttype
  - Special override: if A.AgentCode = 'WEGR' then AgentType = 'We Groups'
  - Else AgentType = COALESCE(ATM.agenttype,'Unknown')
"• AgentType MUST be calculated using this CASE logic:\n"
"\n"
"CASE\n"
" WHEN A.AgentCode = 'WEGR' THEN 'We Groups'\n"
" WHEN ATM.AgentType = 'API' THEN 'API'\n"
" ELSE 'B2B Retail'\n"
"END AS AgentType\n"
"\n"
• Never select BD.AgentId in final output.

### SUPPLIER DIMENSION RULES
• JOIN supplier ONLY when the question mentions supplier / vendor / hotel supplier:
  LEFT JOIN dbo.suppliermaster_Report SM ON BD.SupplierId = SM.EmployeeId
• SupplierName = SM.SupplierName
• Filter by supplier name using PREFIX match: SM.SupplierName LIKE 'term%'
• Never use exact = for SupplierName (stored names may be longer than user typed).

### HOTEL DIMENSION RULES
• DO NOT use BD.HotelChainId, HC.HotelChainId, HotelChainName, HotelChainId.
• The ONLY allowed hotel join is:
  LEFT JOIN dbo.Hotelchain HC ON BD.ProductId = HC.HotelId
• Columns: HC.HotelName, HC.Country, HC.City, HC.Star
• Plain "country" still means destination country from Master_Country, not HC.Country.
• If the question asks for both chain and country, join both:
  LEFT JOIN dbo.Hotelchain HC ON BD.ProductId = HC.HotelId
  LEFT JOIN dbo.Master_Country MC ON BD.ProductCountryid = MC.CountryID
  Use HC only for Chain and MC.Country for Country.
• Chain bucket:
  CASE
    WHEN HC.chain IS NULL THEN 'No Chain Hotels'
    WHEN HC.chain IN ('COURTYARD BY MARRIOTT','Marriott - Renaissance Hotels','Marriott','Marriott International') THEN 'Marriot Group'
    WHEN HC.chain IN ('Hyatt Hotels Corporation','Hyatt Hotels') THEN 'Hyatt Group'
    WHEN HC.chain IN ('Accor - Thalassa','Novotel Accor Hotels','Accor') THEN 'Accor Group'
    WHEN HC.chain IN ('Best Western Hotels','Best Western Hotels & Resorts','Best Western') THEN 'Best Western Group'
    WHEN HC.chain IN ('Kempinski Hotels & Resorts','Kempinski') THEN 'Kempinski Group'
    WHEN HC.chain IN ('Four Seasons','Four Seasons Real Estate','Four Seasons Hotels and Resorts') THEN 'Four Seasons Group'
    WHEN HC.chain IN ('Shangri-La Hotels and Resorts','Shangri-La Hotels - Traders Hotels') THEN 'Shangri-La Group'
    ELSE HC.chain
  END AS Chain

### METRIC DEFINITIONS
• Total Sales = SUM(COALESCE(BD.AgentBuyingPrice,0))
• Total Cost  = SUM(COALESCE(BD.CompanyBuyingPrice,0))
• Total Profit = SUM(COALESCE(BD.AgentBuyingPrice,0) - COALESCE(BD.CompanyBuyingPrice,0))
• Total Booking Count = COUNT(DISTINCT BD.PNRNo)

• Avg Booking Value =
  SUM(COALESCE(BD.AgentBuyingPrice,0))
  / NULLIF(COUNT(DISTINCT BD.PNRNo),0)

• Total Room Nights =
  SUM(DATEDIFF(DAY, BD.CheckInDate, BD.CheckOutDate))

• Avg Booking Window =
  AVG(CAST(DATEDIFF(DAY, BD.CreatedDate, BD.CheckInDate) AS FLOAT))

• Total Last Minute Bookings =
  COUNT(DISTINCT CASE
    WHEN DATEDIFF(DAY, BD.CreatedDate, BD.CheckInDate) <= 1
    THEN BD.PNRNo
  END)

• Total Cancelled Bookings =
  COUNT(DISTINCT CASE
    WHEN BD.BookingStatus = 'Cancelled'
    THEN BD.PNRNo
  END)

• Total Non Refundable Bookings =
  COUNT(DISTINCT CASE
    WHEN DATEDIFF(DAY, BD.CreatedDate, BD.CancellationDate) <= 0
    THEN BD.PNRNo
  END)

--------------------------------------------------------------
### TEXT FILTER RULES (HARD)
• For name-based filters (AgentName, SupplierName, HotelName, ProductName, Country, City):
  - Default MUST be PREFIX match (index-friendly): col LIKE 'term%'
  - DO NOT use leading wildcard by default: col LIKE '%term%'
  - Use '%term%' ONLY if user explicitly asks: contains / match anywhere / partial anywhere / includes / similar
• If term contains a single quote, escape it (SQL): replace ' with ''
• Optional (only if your DB collation is case-sensitive): LOWER(col) LIKE 'term%'
